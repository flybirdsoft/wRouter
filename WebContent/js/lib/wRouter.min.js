/*****************************************
SPA框架

作者 : wuweiwei (邬畏畏)
博客 : www.cnblogs.com/wsoft
github : www.github.com/flybirdsoft

注意：http://www.x.com/x.html#/action/index
注意要有“#”号

功能说明：
1.可配置hash,通过hash的变化触发controller函数
2.自动载入页面模板
3.封装了原生ajax请求处理

wRouter调用执行流程：
1.先调用：wRouter.config(myroute);
2.在调用：wRouter.controller( "myControllerIndex",function(){} );

*****************************************/
!function(win){"use strict";var wRouter={version:"1.0",route:[],defRouteIndex:0,commonControllerHandler:function(t){},endControllerHandler:function(t){},isFirstLoad:!0,prevControllerName:""};wRouter.event={},wRouter.http={useMask:!0},wRouter.template={},wRouter.location={url:"",host:"",fileName:"",port:"",param:"",params:[],action:""},wRouter.isIE=function(){return navigator.userAgent.indexOf("MSIE 7")>0?!0:navigator.userAgent.indexOf("MSIE 6")>0?!0:!1},wRouter.isIE8=function(){return navigator.userAgent.indexOf("MSIE 8")>0?!0:!1},wRouter.onLoad=function(){window.onload=function(){var t=/\/:\w{1,}/;-1==window.location.href.indexOf("#")&&(window.location.href=wRouter.location.fileName+"#"+wRouter.route.routes[wRouter.defRouteIndex].url.replace(t,""),wRouter.isIE()&&wRouter.event.onhashchange())}},wRouter.location.getURL=function(t){void 0!=t?this.url=decodeURI(t):this.url=decodeURI(location.href),this.convertURL()},wRouter.location.convertURL=function(){var t,e,o,r,n={key:"",value:""};if(t=/\/[\u4E00-\u9FFF]+|\w+\.\w+/,t.exec(this.url)&&(this.fileName=t.exec(this.url)[0]),t=/#\S{0,}/,null!=t.exec(this.url)&&(this.action=t.exec(this.url)[0],this.action=this.action.replace("#",""),this.action=this.action.replace(/\?\S+/,""),"/"!=this.action.substr(0,1)&&(this.action="/"+this.action),"/"==this.action.substr(this.action.length-1,1)&&(this.action=this.action.substr(0,this.action.length-1))),t=/\?\S{0,}/,null!=t.exec(this.url))for(this.params=[],this.param=t.exec(this.url)[0],this.param=this.param.replace("?",""),e=this.param.split("&"),r=0;r<e.length;r++)n={key:"",value:""},o=e[r].split("="),n.key=o[0],n.value=o[1],this.params.push(n);this.param=this.param.replace("?","")},win.$location=wRouter.location,wRouter.config=function(t){this.route=t,wRouter.controlLink(),wRouter.onLoad()},wRouter.addRoute=function(t){var e;if(void 0==t.length)this.route.routes.push(t);else for(e=0;e<t.length;e++)this.route.routes.push(t[e])},wRouter.commonController=function(t){void 0!=t?wRouter.commonControllerHandler=t:wRouter.commonControllerHandler=function(){}},wRouter.endController=function(t){void 0!=t?wRouter.endControllerHandler=t:wRouter.endControllerHandler=function(){}},wRouter.controller=function(t,e){var o,r,n,i,a=/\/:\w{1,}/;if(0!=this.route.length){for(n=this.route.routes,r=n.length,i=this.route.otherwise,o=0;r>o;o++)if(n[o].controller==t)return n[o].handler=e,this.run(n[o]),void((n[o].url==this.route.otherwise.redirectTo||n[o].url.replace(a,"")==this.route.otherwise.redirectTo)&&(this.defRouteIndex=o));o==r&&(window.location.href=wRouter.location.fileName+"#"+n[this.defRouteIndex].url.replace(a,""))}},wRouter.callController=function(t,e){var o,r,n,i={};for(n=this.route.routes,r=n.length,i=e,o=0;r>o;o++)n[o].controller==t&&n[o].handler.call(this,i)},wRouter.run=function(t){wRouter.mask.init(),wRouter.location.getURL(),this.compareURL(t),window.onhashchange=function(t){var e;e=t||event,wRouter.location.getURL(e.newURL),wRouter.compareURLs()},this.event.onhashchange=function(){wRouter.location.getURL(location.href),wRouter.compareURLs()}},wRouter.trigger=function(t){if(navigator.userAgent.indexOf("MSIE 7")>0)return void wRouter.event[t].call(this);try{wRouter.event[t].call(this)}catch(e){}},wRouter.extandMethod=function(){},wRouter.extandMethod.prototype.exec=function(){},wRouter.compareURL=function(t){var e,o,r=/\/:\w{1,}/,n="",i={},a=this.route.routes;return t=t,e=wRouter.location.action,o=t.url,t.url.indexOf(":")>0&&(n=t.url.replace(r,""),i[r.exec(t.url)[0].replace("/:","")]=e.replace(n,"")),"/"!=o.substr(0,1)&&(o="/"+o),o==e?(wRouter.template.tmpl(t),wRouter.commonControllerHandler.call(this,wRouter.isFirstLoad),wRouter.isFirstLoad=!1,t.handler.call(this,i),wRouter.endControllerHandler.call(this,this.prevControllerName),void(this.prevControllerName=t.controller)):void(t.url.indexOf(":")>0&&n==e.substr(0,n.length)&&(n.length!=e.length&&"/"!=e.substr(n.length,1)&&(window.location.href=wRouter.location.fileName+"#"+a[this.defRouteIndex].url.replace(r,"")),wRouter.template.tmpl(t),wRouter.commonControllerHandler.call(this,wRouter.isFirstLoad),wRouter.isFirstLoad=!1,t.handler.call(this,i),wRouter.endControllerHandler.call(this,this.prevControllerName),this.prevControllerName=t.controller))},wRouter.compareURLs=function(){var t,e,o,t,r,n,i=/\/:\w{1,}/,a="",s={};for(n=this.route.routes,r=n.length,e=wRouter.location.action,t=0;r>t;t++){if(o=n[t].url,n[t].url.indexOf(":")>0&&(a=n[t].url.replace(i,""),s[i.exec(n[t].url)[0].replace("/:","")]=e.replace(a,"")),"/"!=o.substr(0,1)&&(o="/"+o),o==e)return wRouter.template.tmpl(n[t]),wRouter.commonControllerHandler.call(this,wRouter.isFirstLoad),wRouter.isFirstLoad=!1,n[t].handler.call(this,s),wRouter.endControllerHandler.call(this,this.prevControllerName),void(this.prevControllerName=n[t].controller);if(n[t].url.indexOf(":")>0&&a==e.substr(0,a.length))return a.length!=e.length&&"/"!=e.substr(a.length,1)&&(window.location.href=wRouter.location.fileName+"#"+n[this.defRouteIndex].url.replace(i,"")),wRouter.template.tmpl(n[t]),wRouter.commonControllerHandler.call(this,wRouter.isFirstLoad),wRouter.isFirstLoad=!1,n[t].handler.call(this,s),wRouter.endControllerHandler.call(this,this.prevControllerName),void(this.prevControllerName=n[t].controller)}t==r&&(window.location.href=wRouter.location.fileName+"#"+n[this.defRouteIndex].url.replace(i,""))},wRouter.Injection=function(t,e){var o,r,n=/\(\S+\)/,i=t.toString(),a=n.exec(i),s=[];if(null!=a&&(a=a[0].replace("(","").replace(")",""),s[0]=a,a.indexOf(",")>0&&(s=a.split(",")),"string"==typeof e))for(o=0;o<s.length;o++)for(r=0;r<e.length;r++)s[o]==e[r]},wRouter.template.tmpl=function(t){if(void 0!=wRouter.route.container)if(void 0!=t.template)try{wRouter.route.container.innerHTML=t.template.innerHTML}catch(e){throw new Error("没有找到模板")}else if(void 0!=t.templateUrl)try{var o={url:t.templateUrl,param:{},async:!1,success:function(t){},error:function(){}};wRouter.http.getTmpl(o)}catch(e){throw new Error("没有找到模板")}},wRouter.template.loadTmpl=function(t){wRouter.http.getTmpl(t)};var $template={};win.$template=$template,wRouter.http.get=function(options){wRouter.http.useMask&&wRouter.mask.show();var th=wRouter.http;wAjax.ajax({url:options.url,type:"GET",dataType:"text",data:options.param,success:function(data){var json=eval("("+data+")");void 0!=options.success&&options.success.call(th,json),setTimeout(wRouter.mask.hide,100)},error:function(){void 0!=options.error&&(wRouter.mask.hide(),options.error.call(th))}})},wRouter.http.getTmpl=function(t){var e=t.container||wRouter.route.container,o=wRouter.template,r=!0;void 0!=t.async&&0==t.async&&(r=!1),wAjax.ajax({url:t.url,type:"GET",dataType:"text",data:t.param,async:r,success:function(r){void 0!=t.success&&(e.innerHTML=r,t.success.call(o,r))},error:function(){void 0!=t.success&&t.error.call(o)}})},wRouter.http.postData=function(t){if(void 0==t.url)throw new Error("参数不足");wAjax.ajax({url:t.url,type:"POST",data:$(t.form).serialize(),success:function(e){void 0!=t.success&&t.success.call(this,e)},error:function(){void 0!=t.error&&t.error.call(this,data)}})};var $http={};$http.get=wRouter.http.get,$http.getTmpl=wRouter.http.getTmpl,$http.postData=wRouter.http.postData,win.$http=$http,wRouter.controlLink=function(){var t=/#\S+/,e="";$("a[route]").click(function(){return e=this.href.replace("file://",""),e=e.replace("http://",""),e=t.exec(e),null!=e&&(e=e[0].replace("#","/"),window.location.href=wRouter.location.fileName+"#"+e),wRouter.isIE()&&wRouter.event.onhashchange(window.location.href),!1})},wRouter.mask={created:!1},wRouter.mask.init=function(){wRouter.mask.created||(this.created=!0,this.maskDiv=document.createElement("div"),this.maskDiv.id="_mask_",this.maskDiv.style.position="fixed",this.maskDiv.style.width="100%",this.maskDiv.style.height="100%",this.maskDiv.style.top="0",this.maskDiv.style.left="0",this.maskDiv.style["z-index"]="1000",this.maskDiv.style._position="absolute",this.maskDiv.style.background="#CCC",this.maskDiv.style.opacity="0.4",this.maskDiv.style.filter="alpha(opacity=40)",this.maskDiv.style["text-align"]="center",this.maskDiv.style["vertical-align"]="middle",this.maskDiv.style["padding-top"]="100px",this.maskDiv.style.display="none",this.maskDiv.innerHTML="载入中......",document.getElementsByTagName("body")[0].appendChild(this.maskDiv))},wRouter.mask.show=function(){this.maskDiv.style.display="block"},wRouter.mask.hide=function(){document.getElementById("_mask_").style.display="none"};var wAjax={xmlhttp:null,getFormData:function(t){for(var e=new Array,o=0;o<oForm.elements.length;o++){var r=encodeURIComponent(oForm.elements[o].name);r+="=",r+=encodeURIComponent(oForm.elements[o].value),e.push(r)}return e.join("&")},getParamData:function(t){var e,o="?interval=",r=new Date;if(o+=r.getTime(),void 0==t)return"";for(e in t)o=o+"&"+e+"="+t[e];return o},ajax:function(options){this.options=options;var th=this,data,submitData,async=!0;if(void 0==options.async||options.async||(async=!1),window.XMLHttpRequest)this.xmlhttp=new XMLHttpRequest;else{var arr=["MSXML2.XMLHttp.5.0","MSXML2.XMLHttp.4.0","MSXML2.XMLHttp.3.0","MSXML2.XMLHttp","Microsoft.XMLHttp"];for(i=0;i<arr.length;i++)try{return void(this.xmlhttp=new ActiveXObject(arr[i]))}catch(e){}}"GET"==options.type?(this.xmlhttp.open("get",options.url+this.getParamData(options.data),async),this.xmlhttp.onreadystatechange=function(){4==th.xmlhttp.readyState&&200==th.xmlhttp.status?(void 0==options.dataType||"text"==options.dataType||"html"==options.dataType?data=th.xmlhttp.responseText:"json"==options.dataType.toLowerCase()&&(data=eval("("+th.xmlhttp.responseText+")")),options.success(data)):options.error(data)},this.xmlhttp.send(null)):"POST"==options.type&&(this.xmlhttp.open("post",options.url,async),this.xmlhttp.setRequestHeader("Content-type","application/x-www-form-urlencoded"),this.xmlhttp.onreadystatechange=function(){4==th.xmlhttp.readyState&&200==th.xmlhttp.status?(void 0==options.dataType||"text"==options.dataType||"html"==options.dataType?data=th.xmlhttp.responseText:"json"==options.dataType.toLowerCase()&&(data=eval("("+th.xmlhttp.responseText+")")),options.success(data)):options.error(data)},submitData=this.getParamData(options.data),this.xmlhttp.send(submitData))}};win.wRouter=wRouter}(window);